{% extends "professor/base.html" %}
{% load static %}

{% block title %}Scan Student QR - {{ class_obj.subject }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
   .scan-layout {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 24px;
   }
   .camera-panel {
      display: flex;
      justify-content: center;
   }
   #reader {
      width: 260px;
      height: 260px;
      border-radius: 16px;
      overflow: hidden;
      background: white;
      box-shadow: 0 10px 15px -3px rgb(15 23 42 / 0.25);
   }
   .feed-panel {
      max-width: 640px;
      margin: 0 auto;
   }
   .feed-message {
      margin-bottom: 12px;
   }
   .feed-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: white;
      box-shadow: 0 1px 3px 0 rgb(15 23 42 / 0.08);
   }
   .feed-item-success {
      border-left: 4px solid #22c55e;
   }
   .feed-item-error {
      border-left: 4px solid #ef4444;
   }
   .feed-item-meta {
      font-size: 12px;
      color: #64748b;
   }
   .pill-success {
      background: #dcfce7;
      color: #15803d;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
   }
   .pill-error {
      background: #fee2e2;
      color: #b91c1c;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
   }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50">
   <!-- Header Bar -->
   <div class="nav-bar">
      <div class="container" style="padding-top: 16px; padding-bottom: 16px;">
         <a href="{% url 'professor:class_detail' class_obj.id %}?tab=attendance" class="btn btn-ghost" style="margin-bottom: 16px;">
            ‚Üê Back to Attendance
         </a>

         <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div class="nav-icon">üì∑</div>
            <div>
               <h1 style="font-size: 26px; margin-bottom: 4px;">Scan Student QR Codes</h1>
               <p style="color: #64748b; font-size: 14px;">{{ class_obj.subject }} ‚Ä¢ {{ schedule_time }}</p>
            </div>
         </div>
      </div>
   </div>

   <!-- Main Content -->
   <div class="container" style="padding-top: 24px; padding-bottom: 32px;">
      <div class="scan-layout">
         <!-- Top: camera square -->
         <div class="camera-panel">
            <div id="reader"></div>
         </div>

         <!-- Bottom: live feed -->
         <div class="feed-panel">
            <div id="scan-message" class="feed-message text-sm text-muted">
               Point your camera at a student's QR code. Each valid student will be marked present for this session.
            </div>
            <div id="scan-feed"></div>
         </div>
      </div>
   </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
   let html5QrcodeScanner;
   const classId = {{ class_obj.id }};
   const scannedNames = new Set();

   function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
         const cookies = document.cookie.split(';');
         for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
               cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
               break;
            }
         }
      }
      return cookieValue;
   }

   function appendFeedItem(type, title, detail) {
      const feed = document.getElementById('scan-feed');
      const item = document.createElement('div');
      item.className = 'feed-item ' + (type === 'success' ? 'feed-item-success' : 'feed-item-error');

      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      item.innerHTML = `
         <div>
            <div style="font-weight: 600; font-size: 14px;">${title}</div>
            <div class="feed-item-meta">${detail}</div>
         </div>
         <div style="text-align: right;">
            <div class="${type === 'success' ? 'pill-success' : 'pill-error'}">${type === 'success' ? 'MARKED' : 'NOT ADDED'}</div>
            <div class="feed-item-meta">${time}</div>
         </div>
      `;

      feed.prepend(item);
   }

   function setMessage(html) {
      const el = document.getElementById('scan-message');
      if (el) {
         el.innerHTML = html;
      }
   }

   function handleScan(decodedText) {
      const rawName = (decodedText || '').trim();
      if (!rawName) {
         setMessage('<span class="text-red-500">Empty QR code data.</span>');
         return;
      }

      setMessage('Processing <strong>' + rawName + '</strong> ‚Ä¶');

      fetch(`/professor/class/${classId}/qr/process/`, {
         method: 'POST',
         headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
         },
         body: JSON.stringify({ student_name: rawName }),
      })
      .then(r => r.json())
      .then(data => {
         if (data.success) {
            const name = data.student_name || rawName;
            if (!scannedNames.has(name)) {
               scannedNames.add(name);
               appendFeedItem('success', name, data.message || 'Marked present.');
            }
            setMessage('Ready for next student.');
         } else {
            const name = data.student_name || rawName;
            appendFeedItem('error', name, data.error || 'Could not mark attendance.');
            setMessage('<span class="text-red-500">' + (data.error || 'Error processing QR code.') + '</span>');
         }
      })
      .catch(err => {
         console.error(err);
         appendFeedItem('error', rawName, 'Unexpected error.');
         setMessage('<span class="text-red-500">Unexpected error. Please try again.</span>');
      });
   }

   document.addEventListener('DOMContentLoaded', function() {
      const html5Qr = new Html5Qrcode('reader');
      html5QrcodeScanner = html5Qr;

      function onScanSuccess(decodedText, decodedResult) {
         // Temporarily pause to avoid duplicate rapid scans
         html5Qr.stop().then(() => {
            handleScan(decodedText);
            // Resume after a short delay
            setTimeout(() => {
               html5Qr.start(
                  { facingMode: 'environment' },
                  { fps: 10, qrbox: { width: 220, height: 220 } },
                  onScanSuccess,
                  onScanError
               );
            }, 700);
         }).catch(() => {
            handleScan(decodedText);
         });
      }

      function onScanError(errorMessage) {
         // Ignore continuous scan errors; camera stays running
      }

      html5Qr.start(
         { facingMode: 'environment' },
         { fps: 10, qrbox: { width: 220, height: 220 } },
         onScanSuccess,
         onScanError
      ).catch(err => {
         console.error(err);
         const detail = (err && err.message) ? err.message : String(err || '');
         setMessage('<span class="text-red-500">Unable to access camera. ' + detail + '</span>');
      });
   });

   window.addEventListener('beforeunload', function() {
      if (html5QrcodeScanner && html5QrcodeScanner.stop) {
         html5QrcodeScanner.stop().catch(() => {});
      }
   });
</script>
{% endblock %}
