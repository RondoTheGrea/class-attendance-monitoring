{% extends "student/base.html" %}
{% load static %}

{% block title %}My QR Code - Attendance System{% endblock %}

{% block extra_css %}
<style>
    .qr-code-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
        background: white;
        border-radius: 16px;
        box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.06);
        border: 4px solid #f1f5f9;
    }
    #qrcode {
        padding: 20px;
        background: white;
    }
    #qrcode canvas {
        max-width: 100%;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-50">
    <!-- Header Bar -->
    <div class="nav-bar">
        <div class="container" style="padding-top: 16px; padding-bottom: 16px;">
            <a href="{% url 'student:dashboard' %}" class="btn btn-ghost" style="margin-bottom: 16px;">
                ‚Üê Back to Dashboard
            </a>

            <div style="display: flex; align-items: flex-start; gap: 16px;">
                <div class="nav-icon">üì±</div>
                <div>
                    <h1 style="font-size: 30px; margin-bottom: 8px;">My QR Code</h1>
                    <p style="color: #64748b;">Show this QR code to your professor to mark attendance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" style="padding-top: 32px; padding-bottom: 32px;">
        <div class="card" style="max-width: 500px; margin: 0 auto;">
            <div class="card-content" style="display: flex; flex-direction: column; align-items: center; gap: 24px; padding: 32px;">
                <div class="qr-code-wrapper">
                    <div id="qrcode"></div>
                </div>
                <div style="text-align: center;">
                    <p style="font-weight: 500; color: #0f172a; margin-bottom: 4px; font-size: 18px;">{{ student_name }}</p>
                    <p class="text-sm text-muted" style="margin-top: 8px;">
                        This QR code contains your name. Professors will scan it to mark your attendance.
                    </p>
                </div>
                <div style="display: flex; gap: 12px; width: 100%;">
                    <button onclick="downloadQRCode()" class="btn btn-primary" style="flex: 1;">
                        üì• Download QR Code
                    </button>
                    <a href="{% url 'student:dashboard' %}" class="btn btn-outline" style="flex: 1;">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onload="generateQRCode()"></script>
<script>
    let qrCanvas = null;
    const studentName = "{{ student_name|escapejs }}";
    const qrData = "{{ qr_data|escapejs }}";
    
    function generateQRCode() {
        const container = document.getElementById('qrcode');
        
        if (!container || typeof QRCode === 'undefined') {
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Loading QR Code...</div>';
            }
            return;
        }
        
        try {
            container.innerHTML = '';
            const qr = new QRCode(container, {
                text: qrData,
                width: 280,
                height: 280,
                colorDark: '#000000',
                colorLight: '#FFFFFF'
            });
            
            // Get the canvas after QR code is generated
            setTimeout(function() {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    qrCanvas = canvas;
                }
            }, 100);
        } catch (error) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üî≤</div>
                    <div style="font-weight: 500; color: #64748b;">Error generating QR code</div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 8px;">Please refresh the page</div>
                </div>
            `;
        }
    }
    
    function downloadQRCode() {
        if (!qrCanvas) {
            // Try to get canvas again
            const container = document.getElementById('qrcode');
            const canvas = container ? container.querySelector('canvas') : null;
            if (!canvas) {
                alert('QR code is still loading. Please wait a moment.');
                return;
            }
            qrCanvas = canvas;
        }
        
        // Create a fixed-size image (ID card size: 400x400px square)
        const cardWidth = 400;
        const cardHeight = 400;
        const downloadCanvas = document.createElement('canvas');
        downloadCanvas.width = cardWidth;
        downloadCanvas.height = cardHeight;
        const ctx = downloadCanvas.getContext('2d');
        
        // White background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, cardWidth, cardHeight);
        
        // Add border
        ctx.strokeStyle = '#2563eb';
        ctx.lineWidth = 4;
        ctx.strokeRect(2, 2, cardWidth - 4, cardHeight - 4);
        
        // Calculate QR code size (smaller to fit with text)
        const qrSize = 250;
        const qrX = (cardWidth - qrSize) / 2;
        const qrY = 60;
        
        // Draw QR code
        ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);
        
        // Add text
        ctx.fillStyle = '#0f172a';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        
        // Student name
        ctx.fillText(studentName, cardWidth / 2, 30);
        
        // Bottom text
        ctx.font = '14px Arial';
        ctx.fillStyle = '#64748b';
        ctx.fillText('Student QR Code', cardWidth / 2, cardHeight - 20);
        
        // Download the image
        downloadCanvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-qr-code.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }
    
    // Fallback if script loads before DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', generateQRCode);
    } else {
        generateQRCode();
    }
</script>
{% endblock %}
